#!/bin/zsh

if [[ -z $1 ]]; then
  echo -e "Usage: omacase-install-dev-env <bun|dotnet|go|java|java17|node|ruby>"
  exit 1
fi

INSTALLED_EXTENSIONS=$(code --list-extensions)

install_bun() {
  echo -e "Installing Bun...\n"
  mise use --global bun@latest
}

install_dotnet() {
  echo -e "Installing Dotnet...\n"
  mise use --global dotnet@8
}

install_go() {
  echo -e "Installing Go...\n"
  mise use --global go@latest
}

install_java() {
  echo -e "Installing Java...\n"
  mise use --global java@21
}

install_java17() {
    echo -e "Installing Java v17...\n"
    mise use --global java@17
  }

install_node() {
  echo -e "Installing Node.js...\n"
  mise use --global node@lts
  if [[ -f $HOME/.custom-ca-bundle.pem ]]; then
    NODE_EXTRA_CA_CERTS=$HOME/.custom-ca-bundle.pem
    nodeCustomCaExported=$(grep '^export NODE_EXTRA_CA_CERTS' $HOME/.zshrc)
    if [[ -z "$nodeCustomCaExported" ]]; then
      echo 'export NODE_EXTRA_CA_CERTS="$HOME/.custom-ca-bundle.pem"' >> $HOME/.zshrc
    fi
  fi
  mise x node@lts -- npm install -g yarn pnpm
}

install_ruby() {
  echo -e "Installing Ruby...\n"
  mise use --global ruby@latest
  mise settings add idiomatic_version_file_enable_tools ruby
  mise x ruby -- gem install rails --no-document

  if [[ $INSTALLED_EXTENSIONS != *"shopify.ruby-extensions-pack"* ]]; then
    code --install-extension shopify.ruby-extensions-pack
  fi
  TMP_LAZYVIM_SETTINGS=$(mktemp)
  jq --arg plugin "lazyvim.plugins.extras.lang.ruby" '.extras |= if index($plugin) then . else . + [$plugin] end' $HOME/.config/nvim/lazyvim.json >"$TMP_LAZYVIM_SETTINGS" &&
    mv "$TMP_LAZYVIM_SETTINGS" $HOME/.config/nvim/lazyvim.json

}

case "$1" in 
  bun)
    install_bun
    ;;
  dotnet)
    install_dotnet
    ;;
  go)
    install_go
    ;;
  java)
    install_java
    ;;
  java17)
    install_java17
    ;;
  node)
    install_node
    ;;
  ruby)
    install_ruby
    ;;
esac
